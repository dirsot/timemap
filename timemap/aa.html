<!DOCTYPE HTML>
<html>
  <head>


<script type="text/javascript"
	src="https://maps.googleapis.com/maps/api/js?sensor=false&key=AIzaSyCOxcWddJh31zOy2xRkZLRVKoGlOx76V9k&&libraries=drawing">
	
</script>
<script
	src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
  </head>
  <body>
<style>
  #byte_content {
    margin: 5px 0;
    max-height: 100px;
    overflow-y: auto;
    overflow-x: hidden;
  }
  #byte_range { margin-top: 5px; }
</style>

<input type="file" id="files" name="file" /> Read bytes: 
<span class="readBytesButtons">
  <button>entire file</button>
</span>
<div id="byte_range"></div>
<div id="byte_content"></div>

<script>
   var xml;
   var disaredVersion = "666.0";
  function readBlob(opt_startByte, opt_stopByte) {

    var files = document.getElementById('files').files;
    if (!files.length) {
      alert('Please select a file!');
      return;
    }

    var file = files[0];
    var start = parseInt(opt_startByte) || 0;
    var stop = parseInt(opt_stopByte) || file.size - 1;

    var reader = new FileReader();

    // If we use onloadend, we need to check the readyState.
    reader.onloadend = function(evt) {
      if (evt.target.readyState == FileReader.DONE) { // DONE == 2
        document.getElementById('byte_content').textContent = evt.target.result;
        document.getElementById('byte_range').textContent = 
            ['Read bytes: ', start + 1, ' - ', stop + 1,
             ' of ', file.size, ' byte file'].join('');
			 
		parseFile(evt.target.result);
      }
    };

    var blob = file.slice(start, stop + 1);
    reader.readAsBinaryString(blob);
  }
  function getChildrenTag(element,tag){
	result = [];
	tags = element.childNodes;
	for (var i=0;i<tags.length;i++){
		node = tags[i];
		if(node.tagName && node.tagName.toLowerCase()==tag.toLowerCase()){
			result.push(node);
	}
  }
	return result;
  }
  function getOneChildrenOrException(element,tag){
	nodes = getChildrenTag(element,tag);
	if(nodes.length>1){
		console.log('error');
	}
	if(nodes.length==0){
		console.log('error, no tag '+tag);
	}
	return nodes[0];
  }
  
  function saveStyles(styleTags){
	styles = [];
	for (var i=0;i<styleTags.length;i++){
		style = {};
		node = styleTags[i];
		style.id = node.getAttribute('id');
		IconStyleTag = getOneChildrenOrException(node,'IconStyle');
		LabelStyleTag = getOneChildrenOrException(node,'LabelStyle');
		style.labelStyle = {};
		style.labelStyle.color = getOneChildrenOrException(LabelStyleTag,'color');
		style.labelStyle.scale = getOneChildrenOrException(LabelStyleTag,'scale');
		
		LineStyleTag = getOneChildrenOrException(node,'LineStyle');
		PolyStyleTag = getOneChildrenOrException(node,'PolyStyle');
		
		styles.push(style);
	}
	sessionStorage.styles=JSON.stringify(styles);
	
  }
  
  function savePlacemarks(placemarksTags){
	placemarks = [];
  	for (var i=0;i<placemarksTags.length;i++){
		placemark = {}
		node = placemarksTags[i];
		placemark.id = node.getAttribute('id');
		placemark.name = 'ame';//getOneChildrenOrException(node,'name').firstChild;
		timeSpanTag = getOneChildrenOrException(node,'TimeSpan');
		placemark.timeSpan = {};
		beginTag = getOneChildrenOrException(timeSpanTag,'begin');
		placemark.timeSpan.begin = beginTag.innerHTML;
		styleUrlTag = getOneChildrenOrException(node,'styleUrl');
		//placemark.style = styleUrlTag.innerHTML;
		placemarks.push(placemark);
	}
	sessionStorage.placemarks=JSON.stringify(placemarks);
  }
  function parseFile(inputString){
	xml = $(inputString)[2];
	if(xml.getAttribute('version')!=disaredVersion){
		return;
	}
	dTag  = getChildrenTag(xml,'document');
	if(dTag.length!=1){
		console.log('Tylko jeden document tag moze istniec');
		return;
	}
	documentTag = dTag[0];
	nTag  = getChildrenTag(documentTag,'name');
	if(nTag.length!=1){
		console.log('Tylko jeden name tag moze istniec');
		return;
	}
	sessionStorage['mapName'] = nTag[0].firstChild;
	styleTags  = getChildrenTag(documentTag,'style');
	//saveStyles(styleTags);
	
	placemarkTags  = getChildrenTag(documentTag,'Placemark');
	
	savePlacemarks(placemarkTags)
	
  }
  
  document.querySelector('.readBytesButtons').addEventListener('click', function(evt) {
    if (evt.target.tagName.toLowerCase() == 'button') {
      var startByte = evt.target.getAttribute('data-startbyte');
      var endByte = evt.target.getAttribute('data-endbyte');
      readBlob(startByte, endByte);
    }
  }, false);
  
  $(function() {
	if(!Storage){
	alert('3');
	}
  });
</script>
  </body>
</html>